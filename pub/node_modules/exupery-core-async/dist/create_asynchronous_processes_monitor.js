"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.create_asynchronous_processes_monitor = create_asynchronous_processes_monitor;
const _ei = __importStar(require("exupery-core-internals"));
/**
 * this function helps in keeping track of ongoing async operations
 * async operations are registered and when finished reported as such.
 * when all ongoing operations are finished the onEnd callback is called
 *
 * this function is specifically useful for async map functions
 *
 * @param callback this callback creates a scope within which the counter is provided
 * @param onEnd this callback will be called when all ongoing operations are finished
 */
function create_asynchronous_processes_monitor(monitoring_phase, on_all_finished) {
    let counter = 0;
    /*
     * we need to keep track of if the registration phase is ended or not.
     * it can happen that the counter reaches 0 during the registration phase, specifically if there is no real async calls being made
     * in that case the reportFinished counter is als called during the registration phase.
     * If that happens there should not yet be a call to onEnd().
     */
    let registration_phase_ended = false;
    let on_all_finished_has_been_called = false;
    function checkStatus() {
        if (registration_phase_ended) {
            if (counter === 0) {
                if (on_all_finished_has_been_called === true) {
                    _ei.panic("CORE: already ended");
                }
                on_all_finished_has_been_called = true;
                on_all_finished();
            }
        }
    }
    monitoring_phase({
        'report process started': () => {
            if (on_all_finished_has_been_called) {
                _ei.panic("CORE: async call done after context is ready");
            }
            counter += 1;
        },
        'report process finished': () => {
            if (counter === 0) {
                _ei.panic("CORE: decrement while counter is 0");
            }
            counter -= 1;
            checkStatus();
        },
    });
    registration_phase_ended = true;
    checkStatus();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlX2FzeW5jaHJvbm91c19wcm9jZXNzZXNfbW9uaXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9jcmVhdGVfYXN5bmNocm9ub3VzX3Byb2Nlc3Nlc19tb25pdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFpQkEsc0ZBOENDO0FBL0RELDREQUE2QztBQU83Qzs7Ozs7Ozs7O0dBU0c7QUFDSCxTQUFnQixxQ0FBcUMsQ0FDakQsZ0JBQThDLEVBQzlDLGVBQTJCO0lBRzNCLElBQUksT0FBTyxHQUFHLENBQUMsQ0FBQTtJQUVmOzs7OztPQUtHO0lBQ0gsSUFBSSx3QkFBd0IsR0FBRyxLQUFLLENBQUE7SUFDcEMsSUFBSSwrQkFBK0IsR0FBRyxLQUFLLENBQUE7SUFFM0MsU0FBUyxXQUFXO1FBQ2hCLElBQUksd0JBQXdCLEVBQUUsQ0FBQztZQUUzQixJQUFJLE9BQU8sS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDaEIsSUFBSSwrQkFBK0IsS0FBSyxJQUFJLEVBQUUsQ0FBQztvQkFDM0MsR0FBRyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxDQUFBO2dCQUNwQyxDQUFDO2dCQUNELCtCQUErQixHQUFHLElBQUksQ0FBQTtnQkFDdEMsZUFBZSxFQUFFLENBQUE7WUFDckIsQ0FBQztRQUNMLENBQUM7SUFDTCxDQUFDO0lBQ0QsZ0JBQWdCLENBQUM7UUFDYix3QkFBd0IsRUFBRSxHQUFHLEVBQUU7WUFDM0IsSUFBSSwrQkFBK0IsRUFBRSxDQUFDO2dCQUNsQyxHQUFHLENBQUMsS0FBSyxDQUFDLDhDQUE4QyxDQUFDLENBQUE7WUFDN0QsQ0FBQztZQUNELE9BQU8sSUFBSSxDQUFDLENBQUE7UUFFaEIsQ0FBQztRQUNELHlCQUF5QixFQUFFLEdBQUcsRUFBRTtZQUM1QixJQUFJLE9BQU8sS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDaEIsR0FBRyxDQUFDLEtBQUssQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFBO1lBQ25ELENBQUM7WUFDRCxPQUFPLElBQUksQ0FBQyxDQUFBO1lBQ1osV0FBVyxFQUFFLENBQUE7UUFDakIsQ0FBQztLQUNKLENBQUMsQ0FBQTtJQUNGLHdCQUF3QixHQUFHLElBQUksQ0FBQTtJQUMvQixXQUFXLEVBQUUsQ0FBQTtBQUNqQixDQUFDIn0=