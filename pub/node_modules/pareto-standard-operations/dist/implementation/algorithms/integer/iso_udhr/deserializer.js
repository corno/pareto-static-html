"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.$$ = void 0;
const _ea = __importStar(require("exupery-core-alg"));
/**
 *
 * uhdr is a numerical representation of dates where day 0 is 1948-12-10 (the date of the adoption of the Universal Declaration of Human Rights)
 *
 * This function converts an ISO 8601 date string (YYYY-MM-DD) to a udhr day number
 */
const $$ = ($, abort) => {
    const iso_day_0_offset = -711471; // the number of days that iso day 1 (0001-01-01) is offset relative to udhr day 0 (1948-12-10)
    const month_day_table_normal = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
    const month_day_table_leap = [0, 31, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335];
    const is_leap_year = (year) => (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
    const characters = _ea.text_to_character_list($);
    const parse_iso_date = (characters) => {
        const get_certain_character_at = (characters, index) => {
            return characters.__get_element_at(index).transform(($) => $, () => abort(`index out of bounds`));
        };
        const string_to_number = (characters, start, end) => {
            let result = 0;
            for (let i = start; i < end; i++) {
                const digit = get_certain_character_at(characters, i) - 48;
                if (digit < 0 || digit > 9)
                    return abort(`invalid date format`);
                result = result * 10 + digit;
            }
            return result;
        };
        const dash = 45;
        //validate format
        if (characters.__get_number_of_elements() !== 10) { // YYYY-MM-DD
            return abort(`invalid date format`);
        }
        if (get_certain_character_at(characters, 4) !== dash) { // -
            return abort(`invalid date format`);
        }
        if (get_certain_character_at(characters, 7) !== dash) { // -
            return abort(`invalid date format`);
        }
        return {
            year: string_to_number(characters, 0, 4),
            month: string_to_number(characters, 5, 7),
            day: string_to_number(characters, 8, 10)
        };
    };
    const iso_date = parse_iso_date(characters);
    // Validate month (1-12)
    if (iso_date.month < 1 || iso_date.month > 12) {
        abort(`Invalid month: ${iso_date.month}. Month must be between 1 and 12`);
    }
    // Validate day (1-31, depending on month)
    if (iso_date.day < 1) {
        abort(`Invalid day: ${iso_date.day}. Day must be at least 1`);
    }
    // Check days per month
    const days_in_month = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    let max_day = days_in_month[iso_date.month - 1];
    // Adjust for leap year in February
    if (iso_date.month === 2 && is_leap_year(iso_date.year)) {
        max_day = 29;
    }
    if (iso_date.day > max_day) {
        abort(`Invalid day: ${iso_date.day}. Month ${iso_date.month} has at most ${max_day} days`);
    }
    const full_years = iso_date.year - 1;
    const leap_days_before_current_year = +_ea.integer_division(full_years, 4)
        - _ea.integer_division(full_years, 100)
        + _ea.integer_division(full_years, 400);
    const total_days_before_current_year = full_years * 365 + leap_days_before_current_year;
    const month_days = is_leap_year(iso_date.year) ? month_day_table_leap : month_day_table_normal;
    const days_in_current_year = month_days[iso_date.month - 1] + iso_date.day;
    // Calculate total days since January 1, year 1 CE
    const total_days_since_iso_year_1 = total_days_before_current_year + days_in_current_year;
    // Convert to UDHR day number (add days from  1948-12-10)
    const udhr_day = total_days_since_iso_year_1 + iso_day_0_offset;
    return udhr_day;
};
exports.$$ = $$;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVzZXJpYWxpemVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2ltcGxlbWVudGF0aW9uL2FsZ29yaXRobXMvaW50ZWdlci9pc29fdWRoci9kZXNlcmlhbGl6ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDQSxzREFBdUM7QUFJdkM7Ozs7O0dBS0c7QUFDSSxNQUFNLEVBQUUsR0FBUSxDQUFDLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRTtJQUVoQyxNQUFNLGdCQUFnQixHQUFHLENBQUUsTUFBTSxDQUFBLENBQUMsK0ZBQStGO0lBRWpJLE1BQU0sc0JBQXNCLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFBO0lBQ3RGLE1BQU0sb0JBQW9CLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFBO0lBUXBGLE1BQU0sWUFBWSxHQUFHLENBQUMsSUFBWSxFQUFXLEVBQUUsQ0FDM0MsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLEdBQUcsR0FBRyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQTtJQUc5RCxNQUFNLFVBQVUsR0FBRyxHQUFHLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFFaEQsTUFBTSxjQUFjLEdBQUcsQ0FDbkIsVUFBNEIsRUFDcEIsRUFBRTtRQUdWLE1BQU0sd0JB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